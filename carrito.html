<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carrito - LEVEL-UP GAMER</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg-dark text-white">
  <!-- Header -->
  <nav class="navbar navbar-expand-md navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand fw-bold" href="Inicio-1.html">LEVEL-UP GAMER</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="mainNav" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto me-3">
          <li class="nav-item"><a class="nav-link" href="Inicio.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="productos.html">Productos</a></li>
          <li class="nav-item"><a class="nav-link" href="registro.html">Registro</a></li>
          <li class="nav-item"><a class="nav-link active" href="carrito.html">Carrito 游</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Contenido -->
  <main class="container py-5">
    <h2 class="text-center mb-4">游 Tu Carrito de Compras</h2>

    <!-- Tabla del carrito -->
    <div class="table-responsive mb-4">
      <table class="table table-dark table-bordered text-center align-middle">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Categor칤a</th>
            <th>Precio</th>
            <th>Cantidad</th>
            <th>Subtotal</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="carrito-body">
          <!-- Aqu칤 se agregan din치micamente los productos -->
        </tbody>
      </table>
    </div>

    <!-- Resumen -->
    <div class="text-end">
      <h4>Total a pagar: <span id="total-pagar">$0</span></h4>
      <button class="btn btn-success" id="btn-finalizar-compra">Finalizar compra</button>
      <button class="btn btn-danger ms-2" id="btn-vaciar">Vaciar carrito</button>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-primary text-white text-center py-3 mt-5 w-100">
    <p class="mb-0">&copy; 2025 LEVEL-UP GAMER</p>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="script.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const carritoBody = document.getElementById("carrito-body");
      const totalPagar = document.getElementById("total-pagar");
      const btnVaciar = document.getElementById("btn-vaciar");
      const btnFinalizarCompra = document.getElementById("btn-finalizar-compra");

      // Lee carrito desde localStorage o crea un carrito vac칤o
      let carrito = JSON.parse(localStorage.getItem("carrito")) || [];

      // Verifica si hay un descuento disponible (desde localStorage)
      const descuentoDuoc = localStorage.getItem("descuentoDuoc") === "true";

      // Formatea $ en CLP
      const fmt = (n) => `$${Number(n).toLocaleString("es-CL")}`;

      // Renderiza todas las filas del carrito
      function render() {
        carritoBody.innerHTML = "";

        if (carrito.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td colspan="6" class="text-center text-muted">
              Tu carrito est치 vac칤o. Ve a <a href="productos.html">Productos</a> para agregar 칤tems.
            </td>`;
          carritoBody.appendChild(tr);
          totalPagar.textContent = fmt(0);
          return;
        }

        let total = 0;

        carrito.forEach((item, idx) => {
          const subtotal = item.precio * item.cantidad;
          total += subtotal;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.nombre}</td>
            <td>${item.categoria}</td>
            <td>${fmt(item.precio)}</td>
            <td>
              <input type="number" class="form-control text-center" value="${item.cantidad}" min="1" data-index="${idx}">
            </td>
            <td>${fmt(subtotal)}</td>
            <td>
              <button class="btn btn-danger btn-sm" data-index="${idx}">Eliminar</button>
            </td>
          `;
          carritoBody.appendChild(tr);
        });

        // Aplica el descuento si es v치lido
        if (descuentoDuoc) {
          total = total * 0.8;  // Aplica el 20% de descuento
        }

        totalPagar.textContent = fmt(total);

        // Guarda el carrito actualizado en localStorage
        localStorage.setItem("carrito", JSON.stringify(carrito));
      }

      // Delegaci칩n: Eliminar producto
      carritoBody.addEventListener("click", (e) => {
        if (e.target.matches(".btn-danger")) {
          const i = Number(e.target.dataset.index); // Obt칠n el 칤ndice del producto
          carrito.splice(i, 1); // Elimina el producto del carrito (array)
          render(); // Vuelve a renderizar el carrito

          // Elimina el carrito actualizado de localStorage
          localStorage.setItem("carrito", JSON.stringify(carrito));

          // Actualiza el contador del carrito en la navbar
          actualizarContadorCarrito();
        }
      });

      // Funci칩n para actualizar el contador de productos en la navbar
      function actualizarContadorCarrito() {
        const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
        const totalItems = carrito.reduce((acc, item) => acc + item.cantidad, 0);
        document.getElementById("cart-count").textContent = totalItems;
      }

      // Funci칩n para finalizar la compra
      btnFinalizarCompra.addEventListener("click", () => {
        // Verifica si el carrito est치 vac칤o
        if (carrito.length === 0) {
          alert("Tu carrito est치 vac칤o. Agrega productos para realizar la compra.");
          return;
        }

        // Mostrar mensaje de confirmaci칩n
        const totalCompra = parseFloat(totalPagar.textContent.replace("$", "").replace(".", ""));
        const mensaje = `춰Gracias por tu compra!\n\nTotal a pagar: ${fmt(totalCompra)}\n\nTu compra ha sido procesada correctamente.`;

        // Muestra el mensaje de agradecimiento
        alert(mensaje);

        // Vaciar el carrito y actualizar el localStorage
        localStorage.setItem("carrito", JSON.stringify([]));

        // Actualiza el contador del carrito en la navbar
        actualizarContadorCarrito();

        // Actualiza la vista del carrito
        render();
      });

      // Vaciar carrito
      btnVaciar.addEventListener("click", () => {
        if (confirm("쯉eguro que quieres vaciar el carrito?")) {
          carrito = [];
          render();
        }
      });

      // Inicializa la renderizaci칩n del carrito
      render();
      actualizarContadorCarrito();
    });
  </script>
</body>
</html>
